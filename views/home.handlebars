{{#section 'head'}}
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
    <script id="weatherWidgetTemplate" type="text/x-handlebars-template"> {{>weather}} </script>
    <script id="transitWidgetTemplate" type="text/x-handlebars-template"> {{>transit}} </script>
    <script id="calendarWidgetTemplate" type="text/x-handlebars-template"> {{>calendar}} </script>
{{/section}}


<div class="clearfix" id="container">
    <div class="col col-4 border" id="left-column">
        <div class="weatherWidget m1">
            <p class="h7 caps mb0">weather</p>
            <div class="loaded"></div>
            <div class="loading"></div>
        </div>
        <div class="transitWidget m1">
            <p class="h7 caps mb0">transit</p>
            <div class="loaded"></div>
            <div class="loading"></div>
        </div>
    </div>
    <div class="col col-4 border" id="center-column">
        Reminders go here
    </div>
    <div class="col col-4 border" id="right-column">
        <div class="calendarWidget m1">
            <p class="h7 caps">calendar</p>
            <div class="loaded"></div>
            <div class="loading"></div>
        </div>
    </div>
</div>
<div id="page-status"></div>

{{#section 'jquery'}}
<script>
    $(document).ready(function() {
        $(".loaded").hide();
        var weatherWidgetTemplate = Handlebars.compile($("#weatherWidgetTemplate").html());
        updateWidget("weather", weatherWidgetTemplate);

        var transitWidgetTemplate = Handlebars.compile($("#transitWidgetTemplate").html());
        updateWidget("transit", transitWidgetTemplate);

        var calendarWidgetTemplate = Handlebars.compile($("#calendarWidgetTemplate").html());
        updateWidget("calendar", calendarWidgetTemplate);
    });

    function updateWidget(widget, template) {
        console.log("updating " + widget);
        var widgetClass = "." + widget + "Widget";
        var widgetClassLoaded = widgetClass + " .loaded";
        var widgetClassLoading = widgetClass + " .loading";
        $(widgetClassLoaded).hide();
        $(widgetClassLoading).show();
        retrieveData(widget, function(data) {
            $(widgetClassLoaded).html(template(data));
            $(widgetClassLoaded).show();
            $(widgetClassLoading).hide();
            console.log("finished updating " + widget);
        });
    }

    function retrieveData(widget, cb) {
        $.ajax({
            url: widget,
            type: 'GET',
            data: $(this).serialize(), 
            success: function(data) {
                cb(data.data);
            }, 
            error: function() {
                updateStatus("error retrieving " + widget);
            }
        });
    }

    function updateStatus(status) {
        $("#page-status").show().html(status).fadeOut(2000);
    }
</script>
{{/section}}